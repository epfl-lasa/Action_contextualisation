"""
@Author: Yiting CHEN
@Email: chenyiting@whu.edu.cn
"""
import numpy as np
import trimesh
import copy
import threading

from iiwa_py.interface import iiwa_interface
from allegro_hand_py.interface import allegro_interface

import rospy
import time

DEG2RAD = np.pi / 180


class real_world_demo:
    def __init__(self, init_node):
        if init_node:
            rospy.init_node("demo", anonymous=True)

        # initialize robot arm and hand
        self.robot_arm = iiwa_interface(init_node=False)
        self.hand = allegro_interface(init_node=False)

        self.power_joint_states = [
            [0.7306672007466855, 0.5434870941750685, 0.03410226022237332, -1.5319312911529719, 0.026531851054106464,
             -0.9235011813717647, -1.353810610821643, 0, 0, 0, 0.263, 0.0, 0.0, 0.0],
            [0.461334401493371, 0.34736065835013696, -0.08423953955525335, -1.2781793623059439, -0.0901689478917871,
             -0.8016356927435292, -1.174564501643286, 0, 0, 0, 0.263, 0.0, 0.0, 0.0],
            [0.19200160224005702, 0.15123422252520563, -0.20258133933288003, -1.0244274334589158, -0.2068697468376806,
             -0.6797702041152937, -0.9953183924649289, 0, 0, 0, 0.263, 0.0, 0.0, 0.0],
            [-0.022688373081248676, 0.5767391969409444, 0.10135643199566403, -1.441854832344307, 0.09399329844421166,
             -0.8500833632640679, -1.2465502595105158, 0, 0, 0, 0.263, 0.0, 0.0, 0.0],
            [-0.006321798426135318, 0.653835462221023, 0.15665712882832078, -1.8089804599191173, 0.17127106417601626,
             -0.9201688617695141, -1.553354126387765, 0, 0, 0, 0.263, 0.0, 0.0, 0.0]]

        self.pinch_joint_states = [
            [-1.0026752, 1.0, 0.1526367, -1.78511253, 0.1432322, -1.04540271, 0.0, 0, 0, 0, 0.263, 0.0, 0.0, 0.0],
            [-1.0622081120544653, 0.7717783386438439, -0.032859994807873404, -1.7096730677472711, -0.04123912114479207,
             -1.050613890285485, -0.17382101338921108, 0, 0, 0, 0.263, 0.0, 0.0, 0.0],
            [-1.1217410241089305, 0.5435566772876879, -0.21835668961574684, -1.6342336054945423, -0.22571044228958415,
             -1.0558250705709697, -0.3476420267784221, 0, 0, 0, 0.263, 0.0, 0.0, 0.0],
            [-1.1812739361633957, 0.3153350159315313, -0.4038533844236203, -1.5587941432418135, -0.4101817634343761,
             -1.0610362508564544, -0.5214630401676331, 0, 0, 0, 0.263, 0.0, 0.0, 0.0],
            [-0.6493515006980987, -0.004806582114124321, -0.5607215818904236, -1.630115487400801, -0.5334965511363916,
             -1.0250140263954033, -0.6643587451222798, 0, 0, 0, 0.263, 0.0, 0.0, 0.0],
            [-0.49095127052357396, 0.18688989341440676, -0.3867111264178177, -1.7246816930506008, -0.3546910008522937,
             -1.0130048197965524, -0.5005790863417102, 0, 0, 0, 0.263, 0.0, 0.0, 0.0],
            [-0.3325510403490493, 0.37858636894293785, -0.2127006709452119, -1.8192478987004006, -0.1758854505681958,
             -1.0009956131977016, -0.3367994275611401, 0, 0, 0, 0.263, 0.0, 0.0, 0.0],
            [-0.17415081017452466, 0.5702828444714689, -0.03869021547260593, -1.9138141043502004, 0.0029200997159021178,
             -0.9889864065988508, -0.17301976878057002, 0, 0, 0, 0.263, 0.0, 0.0, 0.0],
            [-0.17592764267564345, 0.7889305136721101, -0.03386975648977609, -1.9613528688110604, 0.005553969117870911,
             -1.097330819727208, -0.1710802033902318, 0, 0, 0, 0.263, 0.0, 0.0, 0.0]]

        self.wrap_joint_states = [
            [-0.0721567820882899, 0.6870185433177471, -1.4362976474767537, -0.8887506858103579, -0.2693628733675883,
             1.1264620153585245, -0.3715346026419649, 0, 0, 0, 0.263, 0.0, 0.0, 0.0],
            [0.011344883730323259, 0.6402633986115696, -1.1574091136361848, -0.7098072811830437, -0.1576152385969774,
             1.0167650690735994, -0.24300087951608282, 0, 0, 0, 0.263, 0.0, 0.0, 0.0],
            [0.09484654954893641, 0.593508253905392, -0.8785205797956165, -0.5308638765557295, -0.04586760382636649,
             0.9070681227886743, -0.11446715639020047, 0, 0, 0, 0.263, 0.0, 0.0, 0.0],
            [0.17834821536754963, 0.5467531091992144, -0.5996320459550487, -0.35192047192841486, 0.06588003094424445,
             0.7973711765037492, 0.014066566735681876, 0, 0, 0, 0.263, 0.0, 0.0, 0.0],
            # [0.2618498811861629, 0.4999979644930368, -0.32074351211448054, -0.17297706730110018, 0.17762766571485536,
            #  0.6876742302188243, 0.1426002898615642, 0, 0, 0, 0.263, 0.0, 0.0, 0.0],
            # [0.3453515470047762, 0.453242819786859, -0.04185497827391231, 0.005966337326214377, 0.2893753004854663,
            #  0.5779772839338999, 0.27113401298744655, 0, 0, 0, 0.263, 0.0, 0.0, 0.0],
            # [0.4288532128233893, 0.4064876750806811, 0.2370335555666558, 0.184909741953529, 0.4011229352560772,
            #  0.4682803376489753, 0.39966773611332884, 0, 0, 0, 0.263, 0.0, 0.0, 0.0],
            # [0.5108303747475613, 0.36058614688012547, 0.5108303747475613, 0.36058614688012547, 0.5108303747475613,
            #  0.36058614688012547, 0.5258547975343051, 0, 0, 0, 0.263, 0.0, 0.0, 0.0],
            # [0.5103340815102376, 0.47065486651293, 0.3062192080980287, 0.23487427750554357, 0.48082635442801497,
            #  0.5364083022051325, 0.4808658898066195, 0, 0, 0, 0.263, 0.0, 0.0, 0.0],
            [0.5097173844937548, 0.6074269316969731, 0.05196811918073356, 0.07866393863844327, 0.4435431750050273,
             0.7548859893185544, 0.42496239750819503, 0, 0, 0, 0.263, 0.0, 0.0, 0.0],
            [0.5091006874772726, 0.7441989968810163, -0.20228296973656168, -0.07754640022865705, 0.40625999558203957,
             0.9733636764319764, 0.3690589052097706, 0, 0, 0, 0.263, 0.0, 0.0, 0.0],
            # [0.5084839904607903, 0.8809710620650595, -0.4565340586538569, -0.23375673909575745, 0.3689768161590518,
            #  1.191841363545398, 0.31315541291134585, 0, 0, 0, 0.263, 0.0, 0.0, 0.0],
            # [0.507867293444308, 1.0177431272491027, -0.7107851475711524, -0.3899670779628579, 0.33169363673606406,
            #  1.410319050658819, 0.2572519206129211, 0, 0, 0, 0.263, 0.0, 0.0, 0.0],
            # [0.5072505964278258, 1.1545151924331458, -0.9650362364884479, -0.5461774168299582, 0.2944104573130763,
            #  1.6287967377722399, 0.20134842831449662, 0, 0, 0, 0.263, 0.0, 0.0, 0.0],
            [0.5066338994113435, 1.291287257617189, -1.2192873254057426, -0.7023877556970584, 0.25712727789008855,
             1.8472744248856607, 0.14544493601607206, 0, 0, 0, 0.263, 0.0, 0.0, 0.0],
            [0.5717223, 1.5, -1.57, -0.7995966, 0.6, 2.0943951, 0.1616571, 1.,
             0.65394598, 0.32134594, 0.263, 0., 0., 0.]
            # [0.5066338994113435, 1.3, -1.2192873254057426, -0.7023877556970584, 0.1,
            #  1.8472744248856607, 0.14544493601607206, 1., 0.65394598, 0.32134594, 0.263, 0., 0., 0.]
        ]

        self.joint_states = self.wrap_joint_states

    def move_to_init_state(self):
        self.move_to_state(self.joint_states[0])

    def run_states(self):
        for state in self.joint_states:
            self.move_to_state(state)
        self.hand.move([0, 1.4, 0.7, 0.832134594,
                        0, 1.4, 0.7, 0.82134594,
                        0, 1.4, 0.7, 0.82134594,
                        0.263, 0., 0., 0.], vel=0.02)

    def move_to_state(self, state):
        arm_q = state[:7]
        hand_q_syn = state[7:]
        hand_p = np.hstack([[0] + hand_q_syn[:3],
                            [0] + hand_q_syn[:3],
                            [0] + hand_q_syn[:3],
                            hand_q_syn[3:]])
        self.robot_arm.move_to_target_joint_position(arm_q)
        self.hand.move(hand_p)


if __name__ == "__main__":
    demo = real_world_demo(init_node=True)
    # demo.robot_arm.ee_translate_wrt_world_frame([0, 0, 0.03])
    # print(demo.robot_arm.joint_states)
    demo.move_to_init_state()
    rospy.sleep(5)
    # # #
    demo.run_states()
    # rospy.sleep(3)

    # demo.robot_arm.move_to_target_joint_position([0.5066338994113435, 1.291287257617189, -1.2192873254057426,
    #                                               -0.7023877556970584, -1, 1.8472744248856607,
    #                                               0.14544493601607206])
    # demo.hand.move([0, 1.4, 0.7, 1,
    #                 0, 1.4, 0.7, 1,
    #                 0, 1.4, 0.7, 1,
    #                 0.263, 0., 0., 0.], vel=0.02)

    # print(demo.robot_arm.joint_states)
    # demo.robot_arm.ee_translate_wrt_world_frame([0, 0, 0.03])
    # print(demo.robot_arm.joint_states)
